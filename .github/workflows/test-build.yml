name: SL3000 Ultimate Fix Build v2

on:
  workflow_dispatch:

env:
  CCACHE_DIR: ${{ github.workspace }}/.ccache

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # ============================
    # ✅ 1. 拉取你的仓库
    # ============================
    - name: Checkout Your Repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ============================
    # ✅ 2. 极限磁盘优化（释放 20GB+）
    # ============================
    - name: Free Disk Space (Ultimate)
      run: |
        sudo rm -rf /usr/share/dotnet \
                    /usr/local/lib/android \
                    /opt/ghc \
                    /opt/hostedtoolcache \
                    /usr/share/man \
                    /usr/share/doc \
                    /usr/share/locale \
                    /usr/lib/jvm \
                    /usr/lib/google-cloud-sdk \
                    /lib/modules/*/kernel/drivers/gpu \
                    /lib/modules/*/kernel/drivers/sound \
                    /lib/modules/*/kernel/drivers/media \
                    /var/lib/apt/lists/*
        sudo apt-get clean
        df -h

    # ============================
    # ✅ 3. 拉取官方 ImmortalWrt（openwrt‑24.10 → Linux 6.6）
    # ============================
    - name: Clone Official ImmortalWrt
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git source
        cd source
        git checkout openwrt-24.10

    # ============================
    # ✅ 4. 覆盖你的 config / mk / dts / patches
    # ============================
    - name: Apply Your Overlay
      run: |
        cp configs/*.config source/.config
        mkdir -p source/target/linux/mediatek/dts
        cp dts/*.dts source/target/linux/mediatek/dts/
        mkdir -p source/target/linux/mediatek/image
        cp mk/*.mk source/target/linux/mediatek/image/
        if [ -d patches ]; then
          cp patches/*.patch source/
        fi

    # ============================
    # ✅ 5. 安装依赖
    # ============================
    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-distutils rsync unzip zlib1g-dev file wget ccache

    # ============================
    # ✅ 6. 缓存 dl
    # ============================
    - name: Cache DL
      uses: actions/cache@v4
      with:
        path: source/dl
        key: dl-${{ github.ref_name }}
        restore-keys: dl-

    # ============================
    # ✅ 7. 缓存 ccache
    # ============================
    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: .ccache
        key: ccache-${{ github.ref_name }}

    # ============================
    # ✅ 8. 缓存 toolchain + host + target
    # ============================
    - name: Cache Toolchain + Host + Target
      uses: actions/cache@v4
      with:
        path: |
          source/staging_dir
          source/toolchain
          source/build_dir/host-*
          source/build_dir/toolchain-*
          source/build_dir/target-*
        key: toolchain-host-target-${{ github.ref_name }}
        restore-keys: toolchain-host-target-

    # ============================
    # ✅ 9. feeds
    # ============================
    - name: Update Feeds
      run: |
        cd source
        ./scripts/feeds update -a
        ./scripts/feeds install -a -f

    # ============================
    # ✅ 10. 单独编译 LLVM（限制线程，避免 OOM）
    # ============================
    - name: Prebuild LLVM (Fix OOM)
      run: |
        cd source
        export MAKEFLAGS="-j2"
        make tools/llvm-bpf/compile V=s

    # ============================
    # ✅ 11. 编译 world（自动重试 + fallback）
    # ============================
    - name: Build Firmware (Ultimate Retry)
      run: |
        cd source
        mkdir -p logs

        export MAKEFLAGS="-j4"

        for i in 1 2 3; do
          echo "=== Build attempt $i ==="
          timeout 40m make && break
          echo "Parallel build failed, retrying single job..."
          timeout 40m make -j1 V=s && break
          echo "Attempt $i failed"
        done

        if ! ls bin/targets/mediatek/filogic/*sysupgrade*.bin >/dev/null 2>&1; then
          echo "Build failed after 3 attempts"
          exit 1
        fi

    # ============================
    # ✅ 12. 检查固件输出
    # ============================
    - name: Check Firmware Output
      run: |
        TARGET_DIR=source/bin/targets/mediatek/filogic
        echo "=== Firmware output ==="
        ls -lh "$TARGET_DIR"

    # ============================
    # ✅ 13. 上传构建产物（测试验证）
    # ============================
    - name: Upload Test Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-test-output
        path: source/bin/targets/mediatek/filogic/
