name: Build-SL3000

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:

  # ============================================================
  # 1. 同步上游（✅ 不再排除 kernel，彻底修复 conninfra/wifi mismatch）
  # ============================================================
  sync-upstream:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout your repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/padavanonly/immortalwrt-mt798x-6.6.git || true
        git fetch upstream

    - name: Merge upstream changes (full sync)
      run: |
        git merge upstream/main --allow-unrelated-histories -X theirs || true
        git push origin HEAD:main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # 2. 编译 SL3000 固件
  # ============================================================
  build:
    runs-on: ubuntu-22.04
    needs: sync-upstream

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # -----------------------------
    # 释放磁盘空间（终极版）
    # -----------------------------
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /usr/lib/jvm
        sudo rm -rf /opt/az
        sudo rm -rf /opt/microsoft
        sudo rm -rf /usr/lib/google-cloud-sdk
        sudo docker image prune -a -f
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        df -h

    # -----------------------------
    # 安装依赖
    # -----------------------------
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils \
          rsync unzip zlib1g-dev file wget ccache

    # -----------------------------
    # ccache（固定 key）
    # -----------------------------
    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ runner.os }}-sl3000
        restore-keys: |
          ccache-${{ runner.os }}-

    - name: Configure ccache
      run: |
        echo 'export CC="ccache gcc"' >> ~/.bashrc
        echo 'export CXX="ccache g++"' >> ~/.bashrc
        echo 'export HOSTCC="ccache gcc"' >> ~/.bashrc
        echo 'export HOSTCXX="ccache g++"' >> ~/.bashrc
        source ~/.bashrc
        ccache -M 5G
        ccache -o compression=true
        ccache -o compression_level=6
        ccache -o sloppiness=file_macro,include_file_mtime,include_file_ctime
        ccache -s

    - name: ccache stats (before)
      run: ccache -s

    # -----------------------------
    # Clone 上游源码（✅ 与 sync-upstream 完全一致）
    # -----------------------------
    - name: Clone Source
      run: |
        git clone --depth 1 https://github.com/padavanonly/immortalwrt-mt798x-6.6.git openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # -----------------------------
    # 应用 SL3000 配置
    # -----------------------------
    - name: Apply Config
      run: |
        cp ./configs/sl3000.config ./openwrt/.config
        cd openwrt
        make defconfig

    # -----------------------------
    # 工具链预热
    # -----------------------------
    - name: Build Toolchain
      run: |
        cd openwrt
        make toolchain/install -j$(nproc)

    # -----------------------------
    # 下载依赖
    # -----------------------------
    - name: Download Packages
      run: |
        cd openwrt
        make download -j8

    # -----------------------------
    # 编译固件
    # -----------------------------
    - name: Build Firmware
      run: |
        cd openwrt
        make -j$(nproc) BUILD_LOG=1 || make -j1 V=s

    - name: ccache stats (after)
      run: ccache -s

    # -----------------------------
    # 上传构建产物
    # -----------------------------
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SL3000-EMMC-Firmware
        path: openwrt/bin/targets/

    # -----------------------------
    # 自动发布 Release
    # -----------------------------
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: SL3000-${{ github.run_id }}
        name: "SL3000 EMMC Build ${{ github.run_id }}"
        draft: false
        prerelease: false
        files: |
          openwrt/bin/targets/**/*.bin
          openwrt/bin/targets/**/*.img
          openwrt/bin/targets/**/*.manifest
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
